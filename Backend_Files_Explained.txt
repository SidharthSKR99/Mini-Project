# SentinelQuant â€” Detailed Backend File Guide

This document explains **every single file** in the backend (`server/`) directory. Use this to demonstrate your deep understanding of the codebase during your review.

---

## ðŸ“‚ Root Directory (`/server`)

### ðŸ“„ `server/index.js`
**The Gateway (Main Entry Point)**
*   **What it does**: This is the first file node executes. It sets up the Express server.
*   **Key Logic**:
    *   **`app.use(cors)`**: Allows your React frontend (on port 5173) to talk to this backend (on port 3000).
    *   **`rateLimit`**: Adds security by limiting IPs to 100 requests per 15 mins (prevents spam).
    *   **`app.use('/api/...')`**: Connects all the route files (see below) to specific URLs.
    *   **`app.listen(PORT)`**: Starts the server and effectively "listens" for incoming traffic.

---

## ðŸ“‚ Database Folder (`/server/db`)

### ðŸ“„ `server/db/index.js`
**The Connection Manager**
*   **What it does**: Establishes the link between Node.js and your PostgreSQL database.
*   **Key Features**:
    *   **`pool`**: Creates a "connection pool" (a cache of open connections) so the server doesn't have to reconnect for every single user request (huge performance boost).
    *   **`query(text, params)`**: A helper function everyone else uses to run SQL. It wraps the raw DB call with error handling and logging.
    *   **`transaction(callback)`**: A helper to run multiple SQL commands safely. If one fails, it "rolls back" (undoes) the others to keep data safe.

### ðŸ“„ `server/db/migrate.js`
**The Setup Script**
*   **What it does**: Runs once to "build" your database structure.
*   **Key Logic**:
    *   Contains raw SQL `CREATE TABLE` commands.
    *   Creates tables: `users`, `stocks`, `news_articles`, `portfolios`, etc.
    *   **Seeding**: Automatically inserts the default 10 stocks (AAPL, MSFT, etc.) so the app isn't empty when you first start it.

---

## ðŸ“‚ Middleware (`/server/middleware`)

### ðŸ“„ `server/middleware/auth.js`
**The Security Guard**
*   **What it does**: Checks who is making the request before letting them access data.
*   **Key Functions**:
    *   **`authenticateToken`**: Looks for a `Authorization: Bearer <token>` header. Uses `jwt.verify()` to check if the token is valid. If yes, it adds the user's ID to the request. If no, it blocks them (401 Error).
    *   **`requireAdmin`**: Checks if the logged-in user has `role: 'admin'`. Used for the Admin Dashboard.
    *   **`requirePro`**: Checks if `tier: 'pro'`. Used to integration-gate features like Backtesting.

---

## ðŸ“‚ Routes (`/server/routes`)

### ðŸ“„ `server/routes/auth.js`
**Login & Registration**
*   **`POST /register`**: Takes email/password. Hashes the password (scrambles it) using `bcrypt` so it's secure. Saves execution to DB.
*   **`POST /login`**: Checks if password matches hash. If correct, issues a **JWT (JSON Web Token)** which is the user's "digital ID card" for the session.

### ðŸ“„ `server/routes/portfolio.js`
**User's Money & Holdings**
*   **`GET /`**: Fetches what stocks the user owns. Calculates `Weight %` (how much of portfolio is AAPL?) and `Total Value`.
*   **`POST /rebalance`**: The most complex route. It doesn't just save data; it calls the *Service* to run the math: "Should I buy or sell to match the latest news sentiment?"
*   **`POST /initialize`**: Gives a new user $10,000 (virtual money) and buys stocks based on *today's* sentiment.

### ðŸ“„ `server/routes/sentiment.js`
**Sentiment Data Feed**
*   **`GET /`**: Returns the "Sentiment Leaderboard" (e.g., AAPL: +0.8 Bullish, TSLA: -0.2 Bearish).
*   **`GET /:symbol`**: Returns the deep-dive history for one stock.
*   **`POST /analyze`**: A trigger to force the AI to read recent news *right now*.

### ðŸ“„ `server/routes/news.js`
**News Feed**
*   **`GET /live`**: Returns the last 50 articles scraped in the past 24 hours. Used for the scrolling ticker.
*   **`GET /stock/:symbol`**: Filters news for just one company.
*   **`POST /scrape`**: Manually triggers the scrapers (NewsAPI, Reddit, Yahoo) to go fetch new content.

### ðŸ“„ `server/routes/admin.js`
**Admin Dashboard**
*   **`GET /users`**: Lists everyone registered on the platform.
*   **`GET /stats`**: Returns system health (Total Users: 50, Total Articles: 1200).
*   *Note*: All routes here are protected by `requireAdmin`.

---

## ðŸ“‚ Services (`/server/services`)

### ðŸ“„ `server/services/sentimentService.js`
**The Brain (AI Logic)**
*   **`analyzeSentiment(text)`**: The core function. It takes text (e.g., "Apple profits soar") and sends it to the **FinBERT AI Model**. It returns a score (-1 to +1).
*   **`calculateWSS(stockId)`**: Calculates "Weighted Sentiment Score".
    *   *Logic*: It grabs all AI scores for a stock from the past 7 days.
    *   *Time Decay*: It multiplies older scores by a decay factor (e.g., news from 5 days ago is worth 10% of news from today). This ensures the portfolio reacts to *fresh* news.

### ðŸ“„ `server/services/portfolioService.js`
**The Quant (Math Logic)**
*   **`calculateTargetWeights()`**: This decides "How much AAPL should I own?".
    *   *Formula*: `60% Sentiment + 40% Equal Weight`.
    *   *Example*: If AAPL sentiment is huge (+0.9), it might suggest 20% allocation. If negative (-0.5), it might drop to 5%.
*   **`rebalancePortfolio(userId)`**:
    1.  Checks current holdings.
    2.  Calculates target weights (optimal).
    3.  If `Difference > 5%`, it generates a `BUY` or `SELL` order to fix it.

---

## ðŸ“‚ Scrapers (`/server/scrapers`)

### ðŸ“„ `server/scrapers/newsScraper.js`
**The Eyes (Data Collection)**
*   **`scrapeNewsAPI()`**: Calls the official NewsAPI.org for high-quality headlines.
*   **`scrapeYahooFinance()`**: Uses `cheerio` (a HTML parser) to visit Yahoo Finance and extract headlines manually.
*   **`scrapeReddit()`**: Visits `r/wallstreetbets` to see what retail traders are hyping.
*   **`detectStockMentions(text)`**: A smart function that scans text for keywords.
    *   *Example*: It knows that "iPhone" or "Tim Cook" = `AAPL`. It maps the news article to the correct Stock ID in the database.
